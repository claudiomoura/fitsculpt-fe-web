name: Secret Hygiene

on:
  pull_request:
  push:
    branches:
      - dev
      - work
      - main

jobs:
  secret-hygiene:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block tracked local env files
        run: |
          set -euo pipefail
          forbidden_env_files="$(git ls-files | grep -E '(^|/)\.env($|\.)' | grep -vE '\.example$' || true)"
          if [ -n "$forbidden_env_files" ]; then
            echo "Tracked env files are not allowed."
            exit 1
          fi

      - name: Scan for common secret patterns
        run: |
          set -euo pipefail

          # Keep this guard simple and dependency-free.
          # Do not print matches to avoid leaking potential secrets in CI logs.
          pattern='(DATABASE_URL\s*=\s*(?!(__REPLACE_ME__|postgres(ql)?://postgres:postgres@localhost))[\"'"'"']?postgres(ql)?://[^[:space:]\"'"'"']+:[^[:space:]\"'"'"']+@|(?:API[_-]?KEY|SECRET[_-]?KEY)\s*[:=]\s*[\"'"'"']?[A-Za-z0-9_\-]{16,}|AKIA[0-9A-Z]{16}|AIza[0-9A-Za-z_-]{35}|sk_(live|test)_[0-9A-Za-z]{16,}|gh[pousr]_[0-9A-Za-z]{36,}|xox[baprs]-[0-9A-Za-z-]{10,}|-----BEGIN (RSA|EC|OPENSSH|DSA|PRIVATE) KEY-----|postgres(ql)?://[^[:space:]]+:[^[:space:]]+@)'

          if git ls-files -z \
            | grep -zv '^apps/api/' \
            | xargs -0 rg -I --hidden --pcre2 -l -e "$pattern" > /dev/null; then
            echo "Potential secrets found in tracked files."
            exit 1
          fi
