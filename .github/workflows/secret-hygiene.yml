name: Secret Hygiene

on:
  pull_request:
  push:
    branches:
      - dev
      - work
      - main

jobs:
  secret-hygiene:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block tracked local env files
        run: |
          set -euo pipefail
          forbidden_env_files="$(git ls-files | grep -E '(^|/)\.env($|\.)' | grep -vE '\.example$' || true)"
          if [ -n "$forbidden_env_files" ]; then
            echo "Tracked env files are not allowed:"
            echo "$forbidden_env_files"
            exit 1
          fi

      - name: Scan for common secret patterns
        run: |
          set -euo pipefail

          pattern='(AKIA[0-9A-Z]{16}|AIza[0-9A-Za-z_-]{35}|sk_(live|test)_[0-9A-Za-z]{16,}|gh[pousr]_[0-9A-Za-z]{36,}|xox[baprs]-[0-9A-Za-z-]{10,}|-----BEGIN (RSA|EC|OPENSSH|DSA|PRIVATE) KEY-----|postgres(ql)?://[^[:space:]]+:[^[:space:]]+@)'

          if git ls-files -z | grep -zv '^apps/api/' | xargs -0 rg -n -I --hidden -e "$pattern"; then
            echo "Potential secrets found in tracked files."
            exit 1
          fi
